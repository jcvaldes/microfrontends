stages:
  - build
variables:
  PRODUCTION_DOMAIN: $PRODUCTION_DOMAIN # Define esta variable en tu proyecto GitLab
  AWS_S3_BUCKET_NAME: $AWS_S3_BUCKET_NAME # Define esta variable en tu proyecto GitLab
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID # Define esta variable en tu proyecto GitLab
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY # Define esta variable en tu proyecto GitLab
  AWS_DISTRIBUTION_ID: $AWS_DISTRIBUTION_ID # Define esta variable en tu proyecto GitLab
  DEFAULT_WORKING_DIRECTORY: 'packages/container'

build-job:
  stage: build
  script:
    - apt-get update -qy
    - apt-get install -y nodejs npm awscli
    - cd $DEFAULT_WORKING_DIRECTORY
    - npm install
    - npm run build
    - aws s3 sync dist s3://${AWS_S3_BUCKET_NAME}/container/latest
      --region us-east-1
    - aws cloudfront create-invalidation
      --distribution-id $AWS_DISTRIBUTION_ID
      --paths "/container/latest/index.html"
      --region us-east-1
  rules:
    - changes:
        - packages/container/**/*
    - when: always
    - if: $CI_COMMIT_REF_NAME == "master"
